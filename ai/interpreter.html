<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SGK AI YorumlayÄ±cÄ±</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      width: 236px;
      min-width: 236px;
      background: #fff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 16px 14px;
      gap: 20px;
      overflow-y: auto;
    }
    .sec-title {
      font-size: 11px;
      font-weight: 700;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: .6px;
      margin-bottom: 8px;
    }
    .api-wrap { position: relative; }
    .api-input {
      width: 100%;
      padding: 8px 36px 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 13px;
      background: #f9fafb;
      outline: none;
    }
    .api-input:focus { border-color: #6366f1; background: #fff; }
    .eye-btn {
      position: absolute;
      right: 8px; top: 50%;
      transform: translateY(-50%);
      background: none; border: none;
      cursor: pointer; font-size: 16px; opacity: .5;
    }
    .eye-btn:hover { opacity: 1; }
    .btn-save {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-save:hover { background: #4f46e5; }
    .key-hint { font-size: 11px; color: #9ca3af; margin-top: 5px; }

    .radio-group { display: flex; flex-direction: column; gap: 7px; }
    .radio-group label {
      display: flex; align-items: center; gap: 8px;
      font-size: 13px; cursor: pointer; color: #374151;
    }

    .quick-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .q-btn {
      padding: 6px 4px;
      font-size: 11.5px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f9fafb;
      cursor: pointer;
      text-align: center;
      color: #374151;
      line-height: 1.3;
      transition: background .12s;
    }
    .q-btn:hover { background: #ede9fe; border-color: #a5b4fc; }

    /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 13px 20px;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
    }
    .topbar-center h1  { font-size: 16px; font-weight: 700; text-align: center; }
    .status-row {
      display: flex; align-items: center; justify-content: center;
      gap: 6px; font-size: 12px; color: #6b7280; margin-top: 3px;
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .dot.green  { background: #22c55e; }
    .dot.red    { background: #ef4444; }
    .dot.yellow { background: #f59e0b; }
    .nav-a { font-size: 12px; color: #6366f1; text-decoration: none; font-weight: 500; white-space: nowrap; }
    .nav-a:hover { text-decoration: underline; }

    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 20px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg { max-width: 80%; padding: 11px 15px; border-radius: 14px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }
    .msg.system {
      align-self: center; max-width: 92%; text-align: center;
      background: #fef2f2; border: 1px solid #fecaca;
      color: #7f1d1d; border-radius: 10px; font-size: 13px;
    }
    .msg.system.info { background: #eff6ff; border-color: #bfdbfe; color: #1e3a8a; }
    .msg.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #6366f1, #7c3aed);
      color: #fff; border-bottom-right-radius: 4px;
    }
    .msg.assistant {
      align-self: flex-start;
      background: #fff; border: 1px solid #e5e7eb;
      color: #111; border-bottom-left-radius: 4px;
    }
    .msg-label { font-size: 11px; font-weight: 700; margin-bottom: 4px; opacity: .6; }

    .dots { display: inline-flex; gap: 4px; align-items: center; }
    .dots span { width: 6px; height: 6px; border-radius: 50%; background: #6366f1; animation: blink 1.2s infinite; }
    .dots span:nth-child(2) { animation-delay: .2s; }
    .dots span:nth-child(3) { animation-delay: .4s; }
    @keyframes blink { 0%,80%,100%{transform:scale(.6);opacity:.4} 40%{transform:scale(1);opacity:1} }

    .input-bar {
      padding: 12px 20px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      display: flex; gap: 8px; align-items: center;
      flex-shrink: 0;
    }
    .input-bar input {
      flex: 1; padding: 10px 16px;
      border: 1px solid #d1d5db; border-radius: 22px;
      font-size: 14px; outline: none; background: #f9fafb;
    }
    .input-bar input:focus { border-color: #6366f1; background: #fff; }
    .btn-send {
      padding: 10px 22px;
      background: linear-gradient(135deg, #6366f1, #7c3aed);
      color: #fff; border: none; border-radius: 22px;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: opacity .15s; white-space: nowrap;
    }
    .btn-send:disabled { opacity: .45; cursor: default; }
    .btn-send:not(:disabled):hover { opacity: .88; }
  </style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">

  <div>
    <div class="sec-title">ğŸ”‘ OpenAI API Key</div>
    <div class="api-wrap">
      <input type="password" id="apiInput" class="api-input" placeholder="sk-..." />
      <button class="eye-btn" onclick="toggleEye()" title="GÃ¶ster/Gizle">ğŸ‘</button>
    </div>
    <button class="btn-save" onclick="saveKey()">Kaydet</button>
    <p class="key-hint">Key localStorage'da saklanÄ±r</p>
  </div>

  <div>
    <div class="sec-title">ğŸ“Š Veri KaynaÄŸÄ±</div>
    <div class="radio-group">
      <label><input type="radio" name="src" value="combined" checked /> Her Ä°kisi</label>
      <label><input type="radio" name="src" value="giris" /> GiriÅŸ Verileri</label>
      <label><input type="radio" name="src" value="cikis" /> Ã‡Ä±kÄ±ÅŸ Verileri</label>
    </div>
  </div>

  <div>
    <div class="sec-title">âš¡ HÄ±zlÄ± Sorular</div>
    <div class="quick-grid">
      <button class="q-btn" onclick="ask('Toplam kayÄ±t sayÄ±sÄ± nedir?')">Toplam KayÄ±t</button>
      <button class="q-btn" onclick="ask('BaÅŸarÄ± oranÄ± nedir?')">BaÅŸarÄ± OranÄ±</button>
      <button class="q-btn" onclick="ask('En yoÄŸun iÅŸyeri hangisi?')">Ä°ÅŸyeri Analizi</button>
      <button class="q-btn" onclick="ask('En Ã§ok karÅŸÄ±laÅŸÄ±lan hata tipi nedir?')">Hata Analizi</button>
      <button class="q-btn" onclick="ask('Ã‡Ä±kÄ±ÅŸ nedenlerini analiz et')">Ã‡Ä±kÄ±ÅŸ Nedenleri</button>
      <button class="q-btn" onclick="ask('GiriÅŸ ve Ã§Ä±kÄ±ÅŸ verilerini karÅŸÄ±laÅŸtÄ±r')">KarÅŸÄ±laÅŸtÄ±rma</button>
      <button class="q-btn" onclick="ask('En yoÄŸun departmanlar hangileri?')">Departmanlar</button>
      <button class="q-btn" onclick="ask('En yoÄŸun pozisyonlar hangileri?')">Pozisyonlar</button>
      <button class="q-btn" onclick="ask('FTE tasarrufu ne kadar?')">FTE Tasarrufu</button>
      <button class="q-btn" onclick="ask('Cinsiyet daÄŸÄ±lÄ±mÄ± nedir?')">Cinsiyet</button>
    </div>
  </div>

</aside>

<!-- MAIN -->
<div class="main">

  <div class="topbar">
    <a href="/sgk_giris/index.html" class="nav-a">â† GiriÅŸ Dashboard</a>
    <div class="topbar-center">
      <h1>SGK AI YorumlayÄ±cÄ±</h1>
      <div class="status-row">
        <span id="dataStatus">Veriler yÃ¼kleniyor...</span>
        &bull;
        API: <span class="dot yellow" id="apiDot"></span>
        <span id="apiStatus">Kontrol ediliyor</span>
      </div>
    </div>
    <a href="/sgk_cikis/index.html" class="nav-a">Ã‡Ä±kÄ±ÅŸ Dashboard â†’</a>
  </div>

  <div class="chat-body" id="chatBody">
    <div class="msg system info" id="welcomeMsg">
      <strong>SGK AI YorumlayÄ±cÄ±</strong>'ya hoÅŸ geldiniz!<br/>
      Hem <strong>Ä°ÅŸe GiriÅŸ</strong> hem de <strong>Ä°ÅŸten Ã‡Ä±kÄ±ÅŸ</strong> verileri Ã¼zerinden soru sorabilirsiniz.<br/>
      Veriler yÃ¼kleniyor...
    </div>
  </div>

  <div class="input-bar">
    <input
      id="qInput"
      type="text"
      placeholder="Sorunuzu yazÄ±n... (Enter ile gÃ¶nderin)"
      onkeydown="if(event.key==='Enter'){event.preventDefault();send();}"
    />
    <button class="btn-send" id="sendBtn" onclick="send()">GÃ¶nder</button>
  </div>

</div>

<script>
// Flask server ile aynÄ± origin (port 5500) â€“ deÄŸiÅŸtirme gerekmez
const API = '';

// â”€â”€ API Key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveKey() {
  const v = document.getElementById('apiInput').value.trim();
  if (!v) return;
  localStorage.setItem('sgk_oai_key', v);
  setApiStatus(true);
  addMsg('system info', 'API key kaydedildi âœ“');
}
function getKey() { return localStorage.getItem('sgk_oai_key') || ''; }
function setApiStatus(ok) {
  document.getElementById('apiDot').className = 'dot ' + (ok ? 'green' : 'red');
  document.getElementById('apiStatus').textContent = ok ? 'BaÄŸlÄ±' : 'Key Eksik';
}
function toggleEye() {
  const i = document.getElementById('apiInput');
  i.type = i.type === 'password' ? 'text' : 'password';
}

// â”€â”€ Veri yÃ¼kleme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let loaded = { giris: false, cikis: false };

async function loadData() {
  try {
    const [rG, rC] = await Promise.all([
      fetch(API + '/api/data/giris'),
      fetch(API + '/api/data/cikis'),
    ]);
    const parts = [];
    if (rG.ok) { const d = await rG.json(); loaded.giris = true; parts.push('GiriÅŸ: ' + d.length + ' kayÄ±t'); }
    else addMsg('system', 'GiriÅŸ verisi yÃ¼klenemedi: ' + rG.status);
    if (rC.ok) { const d = await rC.json(); loaded.cikis = true; parts.push('Ã‡Ä±kÄ±ÅŸ: ' + d.length + ' kayÄ±t'); }
    else addMsg('system', 'Ã‡Ä±kÄ±ÅŸ verisi yÃ¼klenemedi: ' + rC.status);

    document.getElementById('dataStatus').textContent = parts.join(' Â· ') || 'Veri yÃ¼klenemedi';
    const wm = document.getElementById('welcomeMsg');
    if (wm && parts.length) {
      wm.innerHTML =
        '<strong>SGK AI YorumlayÄ±cÄ±</strong>\'ya hoÅŸ geldiniz!<br/>' +
        'Hem <strong>Ä°ÅŸe GiriÅŸ</strong> hem de <strong>Ä°ÅŸten Ã‡Ä±kÄ±ÅŸ</strong> verileri Ã¼zerinden soru sorabilirsiniz.<br/>' +
        parts.join(', ') + ' yÃ¼klendi âœ“';
    }
  } catch (err) {
    document.getElementById('dataStatus').textContent = 'Sunucuya baÄŸlanÄ±lamadÄ±';
    addMsg('system',
      'Flask server Ã§alÄ±ÅŸmÄ±yor!\n\nTerminalde (proje kÃ¶kÃ¼nden) ÅŸunu Ã§alÄ±ÅŸtÄ±rÄ±n:\n' +
      '  bash python_server/start.sh\n\nSonra bu sayfayÄ± yenileyin (F5).'
    );
  }
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMsg(cls, text) {
  const body = document.getElementById('chatBody');
  const d = document.createElement('div');
  d.className = 'msg ' + cls;
  if (cls.includes('assistant')) {
    const l = document.createElement('div');
    l.className = 'msg-label';
    l.textContent = 'AI Asistan';
    d.appendChild(l);
  }
  const s = document.createElement('span');
  s.textContent = text;
  d.appendChild(s);
  body.appendChild(d);
  body.scrollTop = body.scrollHeight;
  return d;
}

function addLoading() {
  const body = document.getElementById('chatBody');
  const d = document.createElement('div');
  d.className = 'msg assistant';
  d.innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
  body.appendChild(d);
  body.scrollTop = body.scrollHeight;
  return d;
}

function getSrc() {
  return (document.querySelector('input[name="src"]:checked') || {}).value || 'combined';
}

async function send() {
  const input = document.getElementById('qInput');
  const btn   = document.getElementById('sendBtn');
  const q     = input.value.trim();
  if (!q) return;
  if (!loaded.giris && !loaded.cikis) {
    addMsg('system', 'Veriler henÃ¼z yÃ¼klenmedi. Flask server Ã§alÄ±ÅŸÄ±yor mu?');
    return;
  }
  input.value = '';
  btn.disabled = true;
  addMsg('user', q);
  const ld = addLoading();

  const ep = { combined: '/api/chat/combined', giris: '/api/chat', cikis: '/api/chat/cikis' }[getSrc()] || '/api/chat/combined';

  try {
    const res  = await fetch(API + ep, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question: q, api_key: getKey() }),
    });
    const data = await res.json();
    ld.remove();
    addMsg('assistant', data.answer || 'YanÄ±t alÄ±namadÄ±.');
    if (data.openai_error) addMsg('system', 'âš  OpenAI: ' + data.openai_error);
  } catch (e) {
    ld.remove();
    addMsg('system', 'Ä°stek hatasÄ±: ' + e.message);
  }
  btn.disabled = false;
  input.focus();
}

function ask(t) { document.getElementById('qInput').value = t; send(); }

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function() {
  const k = getKey();
  if (k) { document.getElementById('apiInput').value = k; setApiStatus(true); }
  else    { setApiStatus(false); }
  loadData();
});
</script>
</body>
</html>
